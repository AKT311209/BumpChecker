<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('loadSheets').addEventListener('click', loadSheets);
        document.getElementById('sheetSelect').addEventListener('change', loadHeaders);
        var csBtn = document.getElementById('getCommentSnippet'); if (csBtn) csBtn.addEventListener('click', getCommentSnippet);
        var rsBtn = document.getElementById('getReactSnippet'); if (rsBtn) rsBtn.addEventListener('click', getReactSnippet);
        document.getElementById('processBtn').addEventListener('click', processAll);
        // validate on inputs and selects
        var inputs = ['commentMin', 'commentMax', 'tagMin', 'tagMax', 'sheetId', 'sheetSelect', 'nameCol', 'secCol', 'idCol', 'reactFile', 'commentFile', 'reactRequired', 'commentsRequired', 'tagsRequired'];
        inputs.forEach(function (id) {
            var el = document.getElementById(id);
            if (!el) return;
            var evt = (el.tagName === 'SELECT' || el.type === 'file') ? 'change' : 'input';
            el.addEventListener(evt, validateForm);
        });
        // also listen to checkboxes to update visibility
        var cbIds = ['reactRequired', 'commentsRequired', 'tagsRequired'];
        cbIds.forEach(function (cid) {
            var c = document.getElementById(cid);
            if (c) {
                ['change', 'input', 'click'].forEach(function (evt) {
                    c.addEventListener(evt, function () { updateFileVisibility(); validateForm(); });
                });
            }
        });
        // initial validation
        updateFileVisibility();
        validateForm();
    });

    function getIdFromInput(val) {
        if (!val) return '';
        // If full URL, extract id
        var m = val.match(/[-\w]{25,}/);
        return m ? m[0] : val;
    }

    function loadSheets() {
        var sheetVal = document.getElementById('sheetId').value.trim();
        var id = getIdFromInput(sheetVal);
        if (!id) return alert('Enter spreadsheet ID or URL');
        document.getElementById('sheetSelect').innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(function (sheets) {
            var sel = document.getElementById('sheetSelect');
            sel.innerHTML = '';
            sheets.forEach(function (name) {
                var o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o);
            });
            loadHeaders();
        }).withFailureHandler(function (err) {
            alert('Error loading sheets: ' + err.message);
        }).getSheetNames(id);
    }

    function loadHeaders() {
        var sheetVal = document.getElementById('sheetId').value.trim();
        var id = getIdFromInput(sheetVal);
        var sheetName = document.getElementById('sheetSelect').value;
        if (!id || !sheetName) return;
        google.script.run.withSuccessHandler(function (headers) {
            populateHeaderSelect('nameCol', headers);
            populateHeaderSelect('secCol', headers);
            populateHeaderSelect('idCol', headers);
            // re-run validation after headers populate
            updateFileVisibility();
            validateForm();
        }).withFailureHandler(function (err) {
            alert('Error loading headers: ' + err.message);
        }).getSheetHeaders(id, sheetName);
    }

    function populateHeaderSelect(id, headers) {
        var sel = document.getElementById(id);
        sel.innerHTML = '';
        headers.forEach(function (h) {
            var o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o);
        });
    }

    function readFileAsText(inputEl) {
        return new Promise(function (resolve) {
            var file = inputEl.files[0];
            if (!file) return resolve('');
            var reader = new FileReader();
            reader.onload = function (e) { resolve(e.target.result); };
            reader.readAsText(file);
        });
    }

    function processAll() {
        var sheetVal = document.getElementById('sheetId').value.trim();
        var id = getIdFromInput(sheetVal);
        if (!id) return alert('Spreadsheet ID required');
        if (!validateForm()) return; // abort if invalid
        var form = {
            sheetId: id,
            sheetName: document.getElementById('sheetSelect').value,
            nameCol: document.getElementById('nameCol').value,
            secondaryCol: document.getElementById('secCol').value,
            identifierCol: document.getElementById('idCol').value,
            reactRequired: document.getElementById('reactRequired') ? document.getElementById('reactRequired').checked : false,
            commentsRequired: document.getElementById('commentsRequired') ? document.getElementById('commentsRequired').checked : false,
            tagsRequired: document.getElementById('tagsRequired') ? document.getElementById('tagsRequired').checked : false,
            commentMin: document.getElementById('commentMin').value,
            commentMax: document.getElementById('commentMax').value,
            tagMin: document.getElementById('tagMin').value,
            tagMax: document.getElementById('tagMax').value,
        };

        // Only read files that are visible/required; readFileAsText resolves to '' if no file
        var reads = [];
        var reactEl = document.getElementById('reactFile');
        var commentEl = document.getElementById('commentFile');
        reads.push(readFileAsText(reactEl));
        reads.push(readFileAsText(commentEl));
        Promise.all(reads).then(function (vals) {
            form.reactCsv = vals[0] || '';
            form.commentCsv = vals[1] || '';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('results').innerHTML = 'Processing...';
            google.script.run.withSuccessHandler(showResults).withFailureHandler(function (err) {
                alert('Processing failed: ' + err.message);
                document.getElementById('processBtn').disabled = false;
            }).processFiles(form);
        });
    }

    function showFormError(msg) {
        var container = document.getElementById('formErrorContainer');
        var el = document.getElementById('formError');
        if (!msg) {
            if (container) container.style.display = 'none';
            if (el) el.textContent = '';
            document.getElementById('processBtn').disabled = false;
            return;
        }
        if (container) container.style.display = 'block';
        if (el) el.textContent = msg;
        document.getElementById('processBtn').disabled = true;
    }

    function validateForm() {
        // required fields
        var sheetId = document.getElementById('sheetId').value;
        var sheetSel = document.getElementById('sheetSelect').value;
        var nameCol = document.getElementById('nameCol').value;
        var secCol = document.getElementById('secCol').value;
        var idCol = document.getElementById('idCol').value;
        var reactReqEl = document.getElementById('reactRequired');
        var commentsReqEl = document.getElementById('commentsRequired');
        var tagsReqEl = document.getElementById('tagsRequired');
        var reactRequired = reactReqEl ? reactReqEl.checked : false;
        var commentsRequired = commentsReqEl ? commentsReqEl.checked : false;
        var tagsRequired = tagsReqEl ? tagsReqEl.checked : false;
        var needCommentUpload = commentsRequired || tagsRequired;
        var reactFile = document.getElementById('reactFile').files[0];
        var commentFile = document.getElementById('commentFile').files[0];

        if (!sheetId || String(sheetId).trim() === '') {
            showFormError('Spreadsheet ID or URL is required');
            return false;
        }
        if (!sheetSel || String(sheetSel).trim() === '') {
            showFormError('Please choose a sheet');
            return false;
        }
        if (!nameCol || String(nameCol).trim() === '') {
            showFormError('Name column must be selected');
            return false;
        }
        if (!secCol || String(secCol).trim() === '') {
            showFormError('Secondary ID column must be selected');
            return false;
        }
        if (!idCol || String(idCol).trim() === '') {
            showFormError('Identifier (FB link) column must be selected');
            return false;
        }
        if (reactRequired) {
            if (!reactFile) {
                showFormError('Please upload the Reacts CSV');
                return false;
            }
        }
        if (needCommentUpload) {
            if (!commentFile) {
                showFormError('Please upload the Comments CSV');
                return false;
            }
        }

        // range checks (only when their requirements are enabled)
        function isBlank(v) { return v === null || v === undefined || String(v).trim() === '' }
        function asInt(v) { return parseInt(v, 10); }
        if (commentsRequired) {
            var cMin = document.getElementById('commentMin').value;
            var cMax = document.getElementById('commentMax').value;
            if (!isBlank(cMax)) {
                var a = asInt(cMin || 0);
                var b = asInt(cMax);
                if (!isNaN(a) && !isNaN(b) && a > b) {
                    showFormError('Comments min cannot be greater than Comments max');
                    return false;
                }
            }
        }
        if (tagsRequired) {
            var tMin = document.getElementById('tagMin').value;
            var tMax = document.getElementById('tagMax').value;
            if (!isBlank(tMax)) {
                var a2 = asInt(tMin || 0);
                var b2 = asInt(tMax);
                if (!isNaN(a2) && !isNaN(b2) && a2 > b2) {
                    showFormError('Tags min cannot be greater than Tags max');
                    return false;
                }
            }
        }

        showFormError('');
        return true;
    }

    function updateFileVisibility() {
        var reactReqEl = document.getElementById('reactRequired');
        var commentsReqEl = document.getElementById('commentsRequired');
        var tagsReqEl = document.getElementById('tagsRequired');
        var reactRequired = reactReqEl ? reactReqEl.checked : false;
        var commentsRequired = commentsReqEl ? commentsReqEl.checked : false;
        var tagsRequired = tagsReqEl ? tagsReqEl.checked : false;
        var reactContainer = document.getElementById('reactFileContainer');
        var commentContainer = document.getElementById('commentFileContainer');
        if (reactContainer) reactContainer.style.display = reactRequired ? 'block' : 'none';
        var showComment = commentsRequired || tagsRequired;
        if (commentContainer) commentContainer.style.display = showComment ? 'block' : 'none';
        // also show/hide the comment/tag criteria rows (min/max inputs)
        var commentCriteria = document.getElementById('commentCriteria');
        var tagCriteria = document.getElementById('tagCriteria');
        if (commentCriteria) commentCriteria.style.display = commentsRequired ? 'flex' : 'none';
        if (tagCriteria) tagCriteria.style.display = tagsRequired ? 'flex' : 'none';
    }

    // Helper to fetch raw file from GitHub blob URL and copy to clipboard
    function githubRawUrl(blobUrl) {
        if (!blobUrl) return blobUrl;
        // Convert https://github.com/<user>/<repo>/blob/<branch>/path -> https://raw.githubusercontent.com/<user>/<repo>/<branch>/path
        return blobUrl.replace(/^https:\/\/github.com\//i, 'https://raw.githubusercontent.com/').replace('/blob/', '/');
    }

    function copyToClipboard(text) {
        if (!text) return Promise.reject(new Error('No text to copy'));
        if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
        }
        return new Promise(function (resolve, reject) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'absolute';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                var ok = document.execCommand('copy');
                document.body.removeChild(ta);
                if (ok) resolve(); else reject(new Error('execCommand copy failed'));
            } catch (e) {
                document.body.removeChild(ta);
                reject(e);
            }
        });
    }

    function getSnippetFromGithub(blobUrl) {
        var raw = githubRawUrl(blobUrl);
        return fetch(raw).then(function (resp) {
            if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
            return resp.text();
        });
    }

    function getCommentSnippet() {
        var url = 'https://github.com/AKT311209/JSUtils/blob/main/Get-Commentors-FB.txt';
        document.getElementById('results').textContent = 'Fetching comment snippet...';
        getSnippetFromGithub(url).then(function (txt) {
            return copyToClipboard(txt).then(function () {
                document.getElementById('results').textContent = 'Comment snippet copied to clipboard.';
            });
        }).catch(function (err) {
            alert('Failed to get/copy comment snippet: ' + err.message);
            document.getElementById('results').textContent = '';
        });
    }

    function getReactSnippet() {
        var url = 'https://github.com/AKT311209/JSUtils/blob/main/Get-Reactors-FB.txt';
        document.getElementById('results').textContent = 'Fetching react snippet...';
        getSnippetFromGithub(url).then(function (txt) {
            return copyToClipboard(txt).then(function () {
                document.getElementById('results').textContent = 'React snippet copied to clipboard.';
            });
        }).catch(function (err) {
            alert('Failed to get/copy react snippet: ' + err.message);
            document.getElementById('results').textContent = '';
        });
    }

    function showResults(payload) {
        document.getElementById('processBtn').disabled = false;
        if (!payload || !payload.results) return document.getElementById('results').textContent = 'No results';
        var results = payload.results;
        var container = document.getElementById('results');
        container.innerHTML = '';

        // Group by flags for readability
        results.forEach(function (r) {
            var card = document.createElement('div'); card.className = 'card';
            var title = document.createElement('div'); title.className = 'card-title';
            title.textContent = r.name + ' — ' + r.secondary;
            var id = document.createElement('div'); id.className = 'muted'; id.textContent = r.identifier;
            var counts = document.createElement('div'); counts.textContent = 'Reacts: ' + r.reacts + '  Comments: ' + r.comments + '  Tags: ' + r.tags;
            var flags = document.createElement('div'); flags.className = 'flags';
            // Render each flag with color coding: OK (green), faults (red), neutral otherwise
            r.flags.forEach(function (f, idx) {
                var span = document.createElement('span');
                span.textContent = f;
                var lower = String(f).toLowerCase();
                if (lower.indexOf('ok') !== -1 || lower.indexOf('reacted') !== -1) {
                    span.className = 'flag-ok';
                } else if (lower.indexOf('no') !== -1 || lower.indexOf('not') !== -1 || lower.indexOf('too') !== -1) {
                    span.className = 'flag-bad';
                } else {
                    span.className = 'flag-neutral';
                }
                flags.appendChild(span);
                if (idx < r.flags.length - 1) {
                    var sep = document.createElement('span'); sep.textContent = ' · '; sep.className = 'flag-sep'; flags.appendChild(sep);
                }
            });
            card.appendChild(title); card.appendChild(id); card.appendChild(counts); card.appendChild(flags);
            container.appendChild(card);
        });
    }
</script>